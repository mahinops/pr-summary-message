name: Multi-Job PR Failure Summary

on:
  push

permissions:
  pull-requests: write
  actions: read

jobs:
  job1:
    name: Job 1
    runs-on: ubuntu-latest
    steps:
      - name: Test1
        id: test1
        run: echo "Test1"
      - name: Test2
        id: test2
        run: false  # This will fail
      - name: Test3
        id: test3
        if: always()
        run: echo "Test3"

  job2:
    name: Job 2
    runs-on: ubuntu-latest
    steps:
      - name: Test4
        id: test4
        run: echo "Test4"
      - name: Test5
        id: test5
        run: echo "Test5"

  job3:
    name: Job 3
    runs-on: ubuntu-latest
    steps:
      - name: Test6
        id: test6
        run: false
      - name: Test7
        id: test7
        run: echo "Test7"

  summary:
    name: Summary
    needs: [job1, job2, job3]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Collect Job Results
        uses: actions/github-script@v6
        id: collect-results
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const workflow_run = await github.rest.actions.getWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId
            });
            
            const jobs = await github.paginate(github.rest.actions.listJobsForWorkflowRun, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId,
              per_page: 100
            });
            
            let summary = "### Workflow Summary\n\n";
            
            for (const job of jobs) {
              summary += `## ${job.name}\n`;
              summary += `Status: ${job.conclusion}\n\n`;
              
              for (const step of job.steps) {
                summary += `- **${step.name}**: ${step.conclusion}\n`;
              }
              
              summary += "\n";
            }
            
            return summary;

      - name: Create PR Comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const summary = ${{ steps.collect-results.outputs.result }};
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: summary
            });

      - name: Print Summary
        run: echo "${{ steps.collect-results.outputs.result }}"